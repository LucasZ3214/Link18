    def draw_formation_panel(self, painter, cx, top_y, others):
        """Draws a list of nearby players under the compass"""
        if not self.players: return
        
        # Filter for remote players
        remote_players = []
        
        local_p = self.players.get('_local')
        if not local_p: return

        for pid, p in self.players.items():
            if pid == '_local': continue
            
            # Calculate Data
            # Distance
            raw_dx = p['x'] - local_p['x']
            raw_dy = p['y'] - local_p['y']
            
            # Scale to meters
            world_w = 65000 
            if self.map_max and self.map_min:
                 world_w = self.map_max[0] - self.map_min[0]
            
            dist_m = math.hypot(raw_dx * world_w, raw_dy * world_w)
            
            # Heading
            p_hdg = 0
            if abs(p.get('dx',0)) > 0.0001 or abs(p.get('dy',0)) > 0.0001:
                 p_hdg = math.degrees(math.atan2(p.get('dy',0), p.get('dx',0))) + 90
                 if p_hdg < 0: p_hdg += 360
                 
            remote_players.append({
                'callsign': p.get('callsign', 'Unknown'),
                'vehicle': p.get('vehicle', '-'), # 1. Extract Vehicle
                'dist': dist_m,
                'hdg': p_hdg,
                'alt': p.get('alt', 0),
                'spd': p.get('spd', 0),
                'color': p.get('color', Qt.GlobalColor.white)
            })
            
        # Sort by distance
        remote_players.sort(key=lambda x: x['dist'])
        
        if not remote_players: return

        # Draw List
        painter.setFont(QFont("Consolas", 10, QFont.Weight.Bold))
        line_h = 20
        # Updated Columns: Pilot, Type, Dist, Hdg, Alt, Spd
        col_widths = [90, 80, 50, 40, 40, 40] 
        total_w = sum(col_widths)
        
        y = top_y + 20
        x = cx - (total_w/2)
        
        # Background
        bg_rect = QRectF(x - 5, y - 5, total_w + 10, ((len(remote_players)+1) * line_h) + 10)
        painter.setBrush(QBrush(QColor(0, 0, 0, 200))) # Darker background
        painter.setPen(QPen(Qt.GlobalColor.white, 1))
        painter.drawRect(bg_rect)
        
        # Header text
        header_labels = ["PILOT", "TYPE", "DST", "HDG", "ALT", "SPD"]
        cur_x = x
        for i, label in enumerate(header_labels):
            w = col_widths[i]
            painter.setPen(QPen(Qt.GlobalColor.gray))
            align_flag = Qt.AlignmentFlag.AlignLeft # Left align all titles
            rect = QRectF(cur_x + 2, y, w - 2, line_h) # Add 2px Left Padding
            painter.drawText(rect, align_flag | Qt.AlignmentFlag.AlignVCenter, label)
            cur_x += w
            
        y += line_h
        painter.setPen(QPen(Qt.GlobalColor.white))
        painter.drawLine(int(x), int(y), int(x+total_w), int(y)) # Header underline
        
        is_kts = CONFIG.get('unit_is_kts', True)
        
        for p in remote_players:
            # Format Data
            dist_unit = CONFIG.get('distance_unit', 'km').lower()
            if dist_unit == 'nm':
                if p['dist'] > 185.2: # Show 0.1nm precision above 0.1nm range
                     d_str = f"{p['dist']/1852:.1f}nm"
                else: 
                     d_str = f"{p['dist']/1852:.2f}nm" # More precision for close formation
            else:
                if p['dist'] > 1000: d_str = f"{p['dist']/1000:.1f}k"
                else: d_str = f"{p['dist']:.0f}m"
            
            spd_val = p['spd']
            if is_kts: spd_val *= 0.539957
            
            row_data = [
                p['callsign'],
                p['vehicle'], # Type
                d_str,
                f"{int(p['hdg']):03d}",
                f"{p['alt']/1000:.1f}",
                f"{int(spd_val)}"
            ]
            
            cur_x = x
            # Draw Row
            for i, text in enumerate(row_data):
                w = col_widths[i]
                
                # Color logic
                painter.setPen(QPen(Qt.GlobalColor.white))
                if i == 0: # Pilot Name
                    painter.setPen(QPen(p['color']))
                # No special color for Type yet?
                
                # Alignment
                align = Qt.AlignmentFlag.AlignRight | Qt.AlignmentFlag.AlignVCenter
                if i <= 1: # Pilot and Type Left Aligned
                    align = Qt.AlignmentFlag.AlignLeft | Qt.AlignmentFlag.AlignVCenter
                
                rect = QRectF(cur_x + 2, y, w - 4, line_h)
                
                # Clip text
                elided_text = painter.fontMetrics().elidedText(str(text), Qt.TextElideMode.ElideRight, int(w-4))
                painter.drawText(rect, align, elided_text)
                
                cur_x += w
            y += line_h       # Draw Vertical Lines
        painter.setPen(QPen(QColor(100, 100, 100), 1))
        cur_x = x
        top_y_line = top_y + 20
        bottom_y_line = y
        for w in col_widths[:-1]: # Don't draw last line? or do?
            cur_x += w
            painter.drawLine(int(cur_x), int(top_y_line), int(cur_x), int(bottom_y_line))

